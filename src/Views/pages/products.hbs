<link rel="stylesheet" href="/static/css/products.css">


<h1>Lista de Productos</h1>

<!-- Filtros y ordenamiento -->
<div class="filters-container">
  <form method="GET" action="/api/products/view" class="filters-form">
    <div class="filter-group">
      <label for="query">Buscar:</label>
      <input type="text" id="query" name="query" placeholder="Categor√≠a o nombre..." value="{{query}}">
    </div>

    <div class="filter-group">
      <label for="sort">Ordenar por precio:</label>
      <select id="sort" name="sort">
        <option value="">Sin ordenar</option>
        <option value="asc" {{#if (eq sort "asc")}}selected{{/if}}>Menor a Mayor</option>
        <option value="desc" {{#if (eq sort "desc")}}selected{{/if}}>Mayor a Menor</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="limit">Productos por p√°gina:</label>
      <select id="limit" name="limit">
        <option value="5" {{#if (eq limit 5)}}selected{{/if}}>5</option>
        <option value="10" {{#if (eq limit 10)}}selected{{/if}}>10</option>
        <option value="20" {{#if (eq limit 20)}}selected{{/if}}>20</option>
      </select>
    </div>

    <button type="submit" class="btn-filter">Filtrar</button>
    <a href="/api/products/view" class="btn-clear">Limpiar</a>
  </form>
</div>

<!-- Lista de productos -->
<div class="products-container">
  {{#each products}}
    <div class="product-card">
      <h3>{{this.title}}</h3>
      <p>{{this.description}}</p>
      <p><strong>Precio:</strong> ${{this.price}}</p>
      <p><strong>Categor√≠a:</strong> {{this.category}}</p>
      <p><strong>Stock:</strong> {{this.stock}}</p>

      {{#if this.thumbnails}}
        {{#if this.thumbnails.length}}
          <img src="{{this.thumbnails.[0]}}" alt="{{this.title}}" width="150" />
        {{else}}
          <img src="/uploads/no-image.png" alt="Sin imagen" width="150" />
        {{/if}}
      {{else}}
        <img src="/uploads/no-image.png" alt="Sin imagen" width="150" />
      {{/if}}

      <!-- Bot√≥n agregar al carrito -->
      <div class="product-actions">
        <form action="/api/carts/{{#if cartId}}{{cartId}}{{else}}0{{/if}}/products/{{this._id}}" method="post" class="add-to-cart-form">
          <div class="quantity-selector">
            <label for="quantity-{{this._id}}">Cantidad:</label>
            <input type="number" id="quantity-{{this._id}}" name="quantity" value="1" min="1" max="{{this.stock}}" class="quantity-input">
          </div>
          
        </form>
        <a href="/product/{{this._id}}" class="btn-detail">Ver detalle</a>
      </div>
    </div>
  {{/each}}
</div>

<!-- Paginaci√≥n -->
<div class="pagination">
  {{#if hasPrevPage}}
    <a href="?page={{prevPage}}&limit={{limit}}{{#if query}}&query={{query}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}">‚¨Ö Anterior</a>
  {{/if}}

  <span>P√°gina {{page}} de {{totalPages}}</span>

  {{#if hasNextPage}}
    <a href="?page={{nextPage}}&limit={{limit}}{{#if query}}&query={{query}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}">Siguiente ‚û°</a>
  {{/if}}
</div>

<!-- Enlace al CSS -->
<link rel="stylesheet" href="/css/products.css" />

<!-- JavaScript (se queda dentro del archivo) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mostrar notificaciones
  function showNotification(message, type = 'info') {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) existingNotification.remove();
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Formularios de agregar al carrito
  document.querySelectorAll('.add-to-cart-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const button = this.querySelector('.btn-add-cart');
      const productId = button.dataset.productId;
      const quantity = this.querySelector('.quantity-input').value;
      button.disabled = true;
      button.textContent = '‚è≥ Agregando...';
      try {
        const response = await fetch(this.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity })
        });
        const result = await response.json();
        if (result.status === 'success') {
          showNotification(`‚úÖ ${result.message}`, 'success');
        } else {
          showNotification(`‚ùå ${result.message}`, 'error');
        }
      } catch (error) {
        showNotification('‚ùå Error al agregar producto al carrito', 'error');
      } finally {
        button.disabled = false;
        button.textContent = 'üõí Agregar al carrito';
      }
    });
  });

  // Validar cantidad
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', function() {
      const max = parseInt(this.getAttribute('max'));
      const value = parseInt(this.value);
      if (value > max) {
        this.value = max;
        showNotification(`‚ö†Ô∏è Cantidad m√°xima: ${max}`, 'info');
      } else if (value < 1) {
        this.value = 1;
      }
    });
  });
});
</script>
